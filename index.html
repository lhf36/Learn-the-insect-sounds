<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Insect Song Learning Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a, #020617 60%, #000 100%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .game-shell {
      width: 100%;
      max-width: 1100px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      padding: 20px 22px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .title-block p {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .meta-block {
      text-align: right;
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.2);
      border: 1px solid rgba(34, 211, 238, 0.3);
      color: #e0f2fe;
      font-size: 0.75rem;
      gap: 4px;
      white-space: nowrap;
    }

    .meta-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22d3ee;
    }

    .mode-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .mode-pill.mode-off {
      background: rgba(185, 28, 28, 0.2);
      border-color: rgba(248, 113, 113, 0.5);
      color: #fecaca;
    }

    .mode-pill.mode-on {
      background: rgba(22, 163, 74, 0.2);
      border-color: rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 18px;
      margin-top: 6px;
    }

    /* Spectrogram side */

    .spectrogram-panel {
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .spectrogram-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: #9ca3af;
      padding-bottom: 4px;
    }

    .spec-label {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 0.7rem;
      color: #a5b4fc;
    }

    .species-tagline-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .species-tagline {
      font-size: 0.82rem;
      color: #a5b4fc;
    }

    .win-mark {
      font-size: 1rem;
      color: #4ade80;
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .win-mark-visible {
      opacity: 1;
      transform: scale(1);
    }

    .spec-level {
      font-size: 0.75rem;
      color: #6ee7b7;
    }

    /* Axes + spectrogram layout */

    .spectrogram-with-axes {
      display: grid;
      grid-template-columns: auto 1fr;
      grid-template-rows: 1fr auto;
      column-gap: 8px;
      row-gap: 4px;
      align-items: center;
    }

    .axis-y-outside {
      grid-row: 1 / 2;
      grid-column: 1 / 2;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
      font-size: 0.78rem;
      color: #e5e7eb;
      text-align: center;
    }

    .spectrogram-frame {
      grid-row: 1 / 2;
      grid-column: 2 / 3;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      min-height: 220px;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }

    .axis-x-outside {
      grid-row: 2 / 3;
      grid-column: 2 / 3;
      font-size: 0.78rem;
      color: #e5e7eb;
      text-align: center;
      padding-top: 2px;
    }

    .spectrogram-image {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }

    .spectrogram-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.6),
        transparent 20%,
        transparent 70%,
        rgba(15, 23, 42, 0.9)
      );
    }

    .amp-box {
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 0.75rem;
      color: #e5e7eb;
      pointer-events: none;
    }

    .spectrogram-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .play-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .play-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.6);
      background: linear-gradient(to right, #1d243c, #312e81);
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.8);
    }

    .play-button:hover {
      filter: brightness(1.1);
    }

    .play-icon {
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-left: 9px solid #e5e7eb;
    }

    .hint-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .feedback-line {
      font-size: 0.85rem;
      min-height: 18px;
    }

    .feedback-line.correct { color: #4ade80; }
    .feedback-line.wrong { color: #fb923c; }

    .fact-box {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.83rem;
      color: #e5e7eb;
    }

    .fact-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .fact-text { font-size: 0.83rem; }

    .photo-box {
      margin-top: 8px;
      padding: 8px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      text-align: center;
    }

    .insect-photo {
      width: 100%;
      max-width: 450px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .credits {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .hidden { display: none; }

    /* Answer side */

    .answers-panel {
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .question-text {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .question-subtitle {
      font-size: 0.83rem;
      color: #9ca3af;
    }

    .answers-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .answer-btn {
      width: 100%;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease,
        border-color 0.12s ease, background-color 0.12s ease;
      gap: 8px;
    }

    .answer-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 7px 14px rgba(15, 23, 42, 0.9);
      border-color: rgba(129, 140, 248, 0.8);
    }

    .answer-btn.correct-choice {
      background: radial-gradient(circle at top left, #16a34a, #052e16);
      border-color: #22c55e;
    }

    .answer-btn.wrong-choice {
      background: radial-gradient(circle at top left, #b45309, #451a03);
      border-color: #f97316;
    }

    .answer-text-group {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .answer-label {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .answer-meta {
      font-size: 0.75rem;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.9);
      color: #9ca3af;
      flex: 0 0 auto;
    }

    .answer-meta.correct {
      background: rgba(22, 163, 74, 0.3);
      color: #bbf7d0;
    }

    .answer-meta.guess {
      background: rgba(59, 130, 246, 0.2);
      color: #bfdbfe;
    }

    .answer-icon {
      flex: 0 0 auto;
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .answer-icon svg {
      width: 36px;
      height: 36px;
      display: block;
    }

    /* Neutral silhouette: subtle gradient */
    .answer-icon svg .silhouette {
      fill: url(#neutralGradient);
    }

    /* Tint on correct / wrong */
    .answer-icon.tint-correct svg .silhouette {
      fill: #4ade80 !important;
    }

    .answer-icon.tint-wrong svg .silhouette {
      fill: #fb923c !important;
    }

    .bottom-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .score-text strong { color: #e5e7eb; }

    .next-btn {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.75);
      background: linear-gradient(to right, #4338ca, #7c3aed);
      color: #f9fafb;
      font-size: 0.86rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .next-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .next-arrow { font-size: 1rem; }

    .game-footer {
      margin-top: 14px;
      border-top: 1px solid rgba(55, 65, 81, 0.8);
      padding-top: 8px;
      font-size: 0.78rem;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
    }

    .game-footer a {
      color: #a5b4fc;
      text-decoration: none;
    }

    .game-footer a:hover {
      text-decoration: underline;
    }

    /* Focus styles for accessibility */
    .answer-btn:focus-visible,
    .play-button:focus-visible,
    .next-btn:focus-visible,
    .mode-pill:focus-visible {
      outline: 2px solid #e5e7eb;
      outline-offset: 2px;
    }

    @media (max-width: 840px) {
      .main-layout { grid-template-columns: minmax(0, 1fr); }
      .meta-block { align-items: flex-start; }
    }

    @media (max-width: 600px) {
      .game-shell { padding: 14px; }
      .question-text { font-size: 1rem; }
    }

    @media (max-width: 480px) {
      .play-button {
        width: 100%;
        justify-content: center;
      }
      .answers-panel {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="game-shell">
    <header class="game-header">
      <div class="title-block">
        <h1>Insect Song Learning Game</h1>
        <p>Match insect calls to spectrograms and species.</p>
      </div>
      <div class="meta-block">
        <div class="meta-pill">
          <span class="meta-dot"></span>
          Spectrogram training
        </div>
        <button
          id="sci-toggle"
          type="button"
          class="mode-pill mode-off"
          aria-pressed="false"
        >
          Show scientific names: OFF
        </button>
      </div>
    </header>

    <main class="main-layout">
      <!-- Spectrogram + fact + photo -->
      <section class="spectrogram-panel">
        <div class="spectrogram-header">
          <div>
            <div class="spec-label">Visualizing sound</div>
            <div class="species-tagline-wrapper">
              <span class="species-tagline" id="spec-tagline">Who is calling?</span>
              <span id="win-mark" class="win-mark">✓</span>
            </div>
          </div>
          <div class="spec-level" id="spec-region">Region: —</div>
        </div>

        <div class="spectrogram-with-axes">
          <div class="axis-y-outside">Frequency (kHz)</div>
          <div class="spectrogram-frame">
            <img
              id="spectrogram-image"
              class="spectrogram-image"
              src=""
              alt="Insect sound spectrogram"
            />
            <div class="spectrogram-overlay"></div>
            <div class="amp-box">Amplitude (brightness)</div>
          </div>
          <div class="axis-x-outside">Time (seconds)</div>
        </div>

        <div class="spectrogram-footer">
          <div class="play-controls">
            <button
              id="play-btn"
              class="play-button"
              type="button"
              aria-label="Play or replay the current insect call"
            >
              <span class="play-icon"></span>
              <span>Play call</span>
            </button>
            <div class="hint-label">
              Tip: match the band of energy and the rhythm of pulses.
            </div>
          </div>
          <div class="feedback-line" id="feedback-line"></div>
        </div>

        <div id="fact-box" class="fact-box">
          <div class="fact-label">After the guess</div>
          <div class="fact-text" id="fact-text">
            Identify the caller to reveal a fun fact.
          </div>
        </div>

        <div id="photo-box" class="photo-box hidden">
          <img id="insect-photo" class="insect-photo" src="" alt="Insect photo" />
          <div id="credits" class="credits"></div>
        </div>
      </section>

      <!-- Answers -->
      <section class="answers-panel">
        <div class="question-text">Which insect is producing this sound?</div>
        <div class="question-subtitle">
          Listen as many times as you like, then choose the common name.
        </div>

        <div id="answers-list" class="answers-list"></div>

        <div class="bottom-controls">
          <div class="score-text" id="score-text">
            Score: <strong>0 / 0</strong>
          </div>
          <button id="next-btn" class="next-btn" type="button" disabled>
            Next spectrogram <span class="next-arrow">➜</span>
          </button>
        </div>
      </section>
    </main>

    <footer class="game-footer">
      <div>Created by Lucas Fink, Cornell University.</div>
      <div>
        Contact:
        <a href="mailto:lhf36@cornell.edu">lhf36@cornell.edu</a>
      </div>
    </footer>

    <audio id="audio-player"></audio>
  </div>

  <script>
    // Neutral gradient definition injected into each SVG via class "silhouette"
    // We'll just reference a shared gradient id in each SVG.

    const INSECT_ICONS = {
      cricket: `
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="neutralGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f1f5f9" />
              <stop offset="100%" stop-color="#e2e8f0" />
            </linearGradient>
          </defs>
          <g class="silhouette" fill="url(#neutralGradient)" stroke="none">
            <!-- body -->
            <path d="M20 16c0-3 4-5 9-5 5 0 9 2 9 5s-4 5-9 5c-5 0-9-2-9-5z"/>
            <!-- head -->
            <path d="M17 15.5c0-1.7 1.4-3 3.2-3 1.7 0 3 1.3 3 3s-1.3 3-3 3c-1.8 0-3.2-1.3-3.2-3z"/>
            <!-- antennae -->
            <path d="M18 14 L8 6 L7 7.5 L17 15z"/>
            <path d="M19 13.5 L9 4.5 L8.2 6.4 L18.1 15z"/>
            <!-- hind leg femur -->
            <path d="M32 19 L39 9 L48 6 L41 12z"/>
            <!-- hind leg tibia -->
            <path d="M39 9 L50 13 L51 15 L41 12z"/>
            <!-- mid leg -->
            <path d="M27 19 L30 26 L28 27 L25 20z"/>
            <!-- fore leg -->
            <path d="M22 18.5 L22.5 25.5 L20.5 26 L20 19z"/>
            <!-- wing over body (tree cricket-style) -->
            <path d="M22 13 L34 12 L40 14 L30 19z" opacity="0.85"/>
          </g>
        </svg>
      `,
      katydid: `
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="neutralGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f1f5f9" />
              <stop offset="100%" stop-color="#e2e8f0" />
            </linearGradient>
          </defs>
          <g class="silhouette" fill="url(#neutralGradient)" stroke="none">
            <!-- leaf-like tegmina -->
            <path d="M18 18 L36 9.5 C40 8 48 11 50 16 C48 20 41 22 32 22.5 L18 19z"/>
            <!-- head -->
            <path d="M16 18c0-1.5 1.3-2.8 2.8-2.8 1.6 0 2.9 1.3 2.9 2.8 0 1.6-1.3 2.9-2.9 2.9A2.86 2.86 0 0 1 16 18z"/>
            <!-- antennae (very long) -->
            <path d="M17 16 L6 6 L5 7.5 L16 17z"/>
            <path d="M18.5 15.5 L7 4.5 L6.2 6.3 L17.4 17z"/>
            <!-- hind leg -->
            <path d="M36 19 L42 9 L54 6 L46 12z"/>
            <path d="M40 21.5 L50 25 L49 26.5 L39 22.5z"/>
            <!-- mid forelegs -->
            <path d="M24 19 L22 25.5 L20 25 L22 18.5z"/>
            <path d="M20 18 L18 24 L16 23.5 L18.2 17.5z"/>
          </g>
        </svg>
      `,
      cicada: `
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="neutralGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f1f5f9" />
              <stop offset="100%" stop-color="#e2e8f0" />
            </linearGradient>
          </defs>
          <g class="silhouette" fill="url(#neutralGradient)" stroke="none">
            <!-- head+thorax -->
            <path d="M22 14 C22 11.5 24 10 26.5 10 H30c2.5 0 4.5 1.5 4.5 4v3c0 2.5-2 4-4.5 4h-3.5C24 21 22 19.5 22 17z"/>
            <!-- abdomen -->
            <path d="M31 13 L39 15.5 C41.5 16.2 43 17.3 43 18.3c0 1.1-1.5 2.2-4 2.9L31 23z"/>
            <!-- closed forewings -->
            <path d="M30 13.5 L45 11 L52 14 L38 17z" opacity="0.9"/>
            <path d="M30 18.5 L45 21.5 L52 19 L38 17z" opacity="0.85"/>
            <!-- legs simplified -->
            <path d="M25 20 L22 25 L20.5 24.5 L23 19z"/>
            <path d="M29 20 L30 26 L28.2 26.5 L27 20.2z"/>
            <path d="M33 18 L38 24 L36.8 25 L32 18.8z"/>
          </g>
        </svg>
      `,
      grasshopper: `
        <svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="neutralGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f1f5f9" />
              <stop offset="100%" stop-color="#e2e8f0" />
            </linearGradient>
          </defs>
          <g class="silhouette" fill="url(#neutralGradient)" stroke="none">
            <!-- thorax and abdomen (short-winged) -->
            <path d="M24 15h10c3 0 5 1.3 6 3l2 3H26c-3 0-6-2-6-4.5 0-1.4 1.2-1.5 4-1.5z"/>
            <!-- head -->
            <path d="M21 16c0-1.6 1.3-2.9 3-2.9 1.7 0 3 1.3 3 2.9 0 1.6-1.3 2.9-3 2.9-1.7 0-3-1.3-3-2.9z"/>
            <!-- short antennae -->
            <path d="M22 14.5 L17 10.5 L16 11.7 L21 15.5z"/>
            <path d="M23.5 14.2 L18 9 L17.3 10.8 L22.6 15.4z"/>
            <!-- big hind femur -->
            <path d="M34 19 L40 9 L50 7.5 L42 13z"/>
            <!-- hind tibia -->
            <path d="M40 9 L51 13.5 L51.5 15.5 L41.5 11.8z"/>
            <!-- mid and fore legs -->
            <path d="M28 19.5 L27 26 L25 26 L26 19z"/>
            <path d="M24 19 L22.5 24.5 L20.8 24 L22.4 18.5z"/>
          </g>
        </svg>
      `
    };

    // ---- 1. Data: common names, facts, credits ----

    const SONGS = [
      {
        commonName: "Four-spotted Tree Cricket",
        species: "Oecanthus quadripunctatus",
        image: "images/Four Spotted Tree Cricket_Spectogram_XC861325.jpeg",
        audio: "audio/XC861325 - Four-spotted tree cricket - Oecanthus quadripunctatus_Daniel_Parker.wav",
        photo: "images/Four Spotted Tree Cricket_Photo 100453434, no rights reserved, uploaded by Megan Ralph.jpg",
        region: "North America",
        fact: "Four-spotted tree crickets high pitched trills from up in the trees. They amplify their songs by building tools called baffles out of leaves.",
        photoCredit: "Megan Ralph",
        audioCredit: "Daniel Parker",
        iconType: "cricket"
      },
      {
        commonName: "Swamp Cicada",
        species: "Neotibicen tibicen",
        image: "images/Neotibicen_tibicen_Spectrogram.jpeg",
        audio: "audio/Neotibicen_tibicen_australis_filtered_David_Marshall.mp3",
        photo: "images/Neotibicen tibicen_\"Alie\" Kratzer_Swamp Cicada.jpeg",
        region: "Eastern U.S.",
        fact: "Swamp cicadas produce loud songs by vibrating a thin membrane of an organ on their abdomen called a tymbal. Their songs are so loud that they actually turn down their hearing when they sing to avoid going deaf!",
        photoCredit: "\"Alie\" Kratzer",
        audioCredit: "David Marshall",
        iconType: "cicada"
      },
      {
        commonName: "Common True Katydid",
        species: "Pterophylla camellifolia",
        image: "images/Pterophylla camellifolia Common True Katydid spectrogram.jpeg",
        audio: "audio/XC1033657 - Pterophylla camellifolia_Francisco_Rivas_Fuenzalida.wav",
        photo: "images/Pterophylla camellifolia  Common true Katydid_Judy Gallagher_Image.jpg",
        region: "Eastern U.S. forests",
        fact: "Common true katydids produce rhythmic songs by rubbing their wings together. Unlike crickets who are righties, katydids are all lefties and rub their left wing over their right wings.",
        photoCredit: "Judy Gallagher",
        audioCredit: "Francisco Rivas Fuenzalida",
        iconType: "katydid"
      },
      {
        commonName: "Meadow Grasshopper",
        species: "Pseudochorthippus parallelus",
        image: "images/Meadow Grasshopper Spectrogram.jpeg",
        audio: "audio/XC446417 - Meadow Grasshopper - Pseudochorthippus parallelus_Baudewijn_Ode .mp3",
        photo: "images/Meadow Grasshopper_Gilles_San_Martin.jpg",
        region: "European grasslands",
        fact: "Male meadow grasshoppers create their percussive songs by rubbing their hind legs against hard forewings. Most grasshoppers don't actually sing, but some of the few species that do can be very easy to find.",
        photoCredit: "Gilles San Martin",
        audioCredit: "Baudewijn Ode",
        iconType: "grasshopper"
      }
    ];

    const ALL_COMMON_NAMES = SONGS.map(s => s.commonName);

    // ---- 2. State ----

    let scoreCorrect = 0;
    let scoreTotal = 0;
    let hasAnswered = false;
    let sciNamesOn = false;

    // playlist to ensure each species appears once per cycle
    let playlist = [];
    let playlistIndex = 0;
    let currentSong = null;

    const spectrogramImageEl = document.getElementById("spectrogram-image");
    const specTaglineEl = document.getElementById("spec-tagline");
    const specRegionEl = document.getElementById("spec-region");
    const factTextEl = document.getElementById("fact-text");
    const feedbackLineEl = document.getElementById("feedback-line");
    const answersListEl = document.getElementById("answers-list");
    const scoreTextEl = document.getElementById("score-text");
    const playBtnEl = document.getElementById("play-btn");
    const nextBtnEl = document.getElementById("next-btn");
    const audioPlayerEl = document.getElementById("audio-player");
    const photoBoxEl = document.getElementById("photo-box");
    const insectPhotoEl = document.getElementById("insect-photo");
    const creditsEl = document.getElementById("credits");
    const sciToggleBtn = document.getElementById("sci-toggle");
    const winMarkEl = document.getElementById("win-mark");

    // for ding sound
    let audioCtx = null;

    // ---- 3. Helpers ----

    function shuffleArray(arr) {
      return arr
        .map(v => ({ v, r: Math.random() }))
        .sort((a, b) => a.r - b.r)
        .map(x => x.v);
    }

    function initPlaylist() {
      playlist = shuffleArray(SONGS.slice());
      playlistIndex = 0;
    }

    function getNextSong() {
      if (playlist.length === 0 || playlistIndex >= playlist.length) {
        initPlaylist();
      }
      return playlist[playlistIndex++];
    }

    function buildChoices(correctName) {
      const others = ALL_COMMON_NAMES.filter(n => n !== correctName);
      const numOptions = Math.min(4, ALL_COMMON_NAMES.length);
      const wrong = shuffleArray(others).slice(0, numOptions - 1);
      return shuffleArray([correctName, ...wrong]);
    }

    function updateSciToggleUI() {
      if (sciNamesOn) {
        sciToggleBtn.classList.add("mode-on");
        sciToggleBtn.classList.remove("mode-off");
        sciToggleBtn.textContent = "Show scientific names: ON";
        sciToggleBtn.setAttribute("aria-pressed", "true");
      } else {
        sciToggleBtn.classList.add("mode-off");
        sciToggleBtn.classList.remove("mode-on");
        sciToggleBtn.textContent = "Show scientific names: OFF";
        sciToggleBtn.setAttribute("aria-pressed", "false");
      }
    }

    function applySciToggleToButtons() {
      const buttons = answersListEl.querySelectorAll(".answer-btn");
      buttons.forEach(btn => {
        const labelSpan = btn.querySelector(".answer-label");
        if (!labelSpan) return;
        if (sciNamesOn) {
          labelSpan.textContent = btn.dataset.scientificName;
        } else {
          labelSpan.textContent = btn.dataset.commonName;
        }
      });
    }

    function showWinMark() {
      winMarkEl.classList.add("win-mark-visible");
      setTimeout(() => {
        winMarkEl.classList.remove("win-mark-visible");
      }, 800);
    }

    function playDing() {
      try {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audioCtx = new Ctx();
        }
        const ctx = audioCtx;
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, now); // A5-ish
        osc.connect(gain);
        gain.connect(ctx.destination);

        gain.gain.setValueAtTime(0.001, now);
        gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);

        osc.start(now);
        osc.stop(now + 0.35);
      } catch (e) {
        // fail silently if audio context isn't allowed
      }
    }

    function playFromStart() {
      audioPlayerEl.currentTime = 0;
      audioPlayerEl.play().catch(() => {});
    }

    function togglePlayPause() {
      if (audioPlayerEl.paused) {
        audioPlayerEl.play().catch(() => {});
      } else {
        audioPlayerEl.pause();
      }
    }

    // ---- 4. Rendering ----

    function renderSpectrogram(song) {
      spectrogramImageEl.src = song.image;
      spectrogramImageEl.alt = `Spectrogram of ${song.commonName} call`;

      specRegionEl.textContent = song.region ? `Region: ${song.region}` : "Region: —";

      factTextEl.textContent = "Identify the caller to reveal a fun fact.";
      feedbackLineEl.textContent = "";
      feedbackLineEl.className = "feedback-line";

      insectPhotoEl.src = "";
      insectPhotoEl.alt = "";
      photoBoxEl.classList.add("hidden");
      creditsEl.textContent = "";

      audioPlayerEl.src = song.audio;

      // tagline resets at the start of each round
      specTaglineEl.textContent = "Who is calling?";
      winMarkEl.classList.remove("win-mark-visible");
    }

    function renderAnswers(song) {
      answersListEl.innerHTML = "";
      const choices = buildChoices(song.commonName);

      choices.forEach(commonName => {
        const songObj = SONGS.find(s => s.commonName === commonName);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "answer-btn";
        btn.setAttribute("aria-label", `Guess: ${commonName}`);

        btn.dataset.commonName = songObj.commonName;
        btn.dataset.scientificName = songObj.species;

        const textGroup = document.createElement("span");
        textGroup.className = "answer-text-group";

        const label = document.createElement("span");
        label.className = "answer-label";
        label.textContent = sciNamesOn ? songObj.species : songObj.commonName;

        const meta = document.createElement("span");
        meta.className = "answer-meta";
        meta.textContent = "Guess";

        textGroup.appendChild(label);
        textGroup.appendChild(meta);

        const iconSpan = document.createElement("span");
        iconSpan.className = "answer-icon";
        iconSpan.innerHTML = INSECT_ICONS[songObj.iconType] || "";

        btn.appendChild(textGroup);
        btn.appendChild(iconSpan);

        // Clicking still passes the common name internally
        btn.addEventListener("click", () => handleAnswer(songObj.commonName, btn));
        answersListEl.appendChild(btn);
      });
    }

    // ---- 5. Interaction ----

    function handleAnswer(selectedName, buttonEl) {
      if (hasAnswered) return;
      hasAnswered = true;
      scoreTotal++;

      const correct = selectedName === currentSong.commonName;

      if (correct) {
        scoreCorrect++;
        feedbackLineEl.textContent = "Correct! Nice listening.";
        feedbackLineEl.classList.add("correct");
        playDing();
        showWinMark();
      } else {
        feedbackLineEl.textContent = `Not quite. This spectrogram belongs to ${currentSong.commonName}.`;
        feedbackLineEl.classList.add("wrong");
      }

      specTaglineEl.textContent = currentSong.commonName;
      factTextEl.textContent = currentSong.fact || "";

      insectPhotoEl.src = currentSong.photo;
      insectPhotoEl.alt = `Photo of ${currentSong.commonName}`;
      photoBoxEl.classList.remove("hidden");
      creditsEl.textContent = `Photo: ${currentSong.photoCredit} · Audio: ${currentSong.audioCredit}`;

      const buttons = answersListEl.querySelectorAll(".answer-btn");
      buttons.forEach(btn => {
        const meta = btn.querySelector(".answer-meta");
        const iconSpan = btn.querySelector(".answer-icon");

        if (btn.dataset.commonName === currentSong.commonName) {
          btn.classList.add("correct-choice");
          if (meta) {
            meta.textContent = "Answer";
            meta.classList.add("correct");
          }
          if (iconSpan) {
            iconSpan.classList.add("tint-correct");
          }
        }
        if (btn === buttonEl && !correct && meta) {
          btn.classList.add("wrong-choice");
          meta.textContent = "Your guess";
          meta.classList.add("guess");
          if (iconSpan) {
            iconSpan.classList.add("tint-wrong");
          }
        }
        btn.disabled = true;
      });

      scoreTextEl.innerHTML = `Score: <strong>${scoreCorrect} / ${scoreTotal}</strong>`;
      nextBtnEl.disabled = false;
    }

    function loadNewRound() {
      hasAnswered = false;
      nextBtnEl.disabled = true;
      currentSong = getNextSong();
      renderSpectrogram(currentSong);
      renderAnswers(currentSong);
    }

    // ---- 6. Events ----

    playBtnEl.addEventListener("click", playFromStart);
    nextBtnEl.addEventListener("click", loadNewRound);

    sciToggleBtn.addEventListener("click", () => {
      sciNamesOn = !sciNamesOn;
      updateSciToggleUI();
      applySciToggleToButtons();
    });

    // Spacebar play/pause
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" || e.key === " ") {
        const tag = (e.target && e.target.tagName || "").toLowerCase();
        if (tag === "input" || tag === "textarea" || e.target.isContentEditable) {
          return;
        }
        e.preventDefault();
        togglePlayPause();
      }
    });

    // Kick off
    initPlaylist();
    updateSciToggleUI();
    loadNewRound();
  </script>
</body>
</html>
